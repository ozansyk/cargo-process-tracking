<!doctype html>
<html lang="tr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main-layout}">
<head>
    <title layout:fragment="title">Kargo Sorgula/Güncelle</title>
    <!-- Bu sayfaya özel stiller (main-layout.html'dekilerle birleşecek) -->
    <th:block layout:fragment="pageStyles">
        <style>
            .table-sm th, .table-sm td { vertical-align: middle; } /* panel-sorgula'ya özeldi, layout'a taşınabilir ya da burada kalabilir */
            .badge { font-size: 0.85em; } /* panel-sorgula'ya özel badge boyutu, layout'taki genel badge'i ezer */
            .filter-card { background-color: #ffffff; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
            .modal-dialog-scrollable .modal-body { max-height: 70vh; overflow-y: auto; }
            #modalLoadingIndicator { padding: 3rem 0; }
            .pagination .page-item.active .page-link { z-index: 1; }
            #modalContentArea p { margin-bottom: 0.5rem; }
            #modalContentArea h5 { margin-top: 1rem; margin-bottom: 0.25rem; font-size: 1rem; color: #6c757d;}
            #modalContentArea h5:first-of-type { margin-top: 0; }
            .btn .spinner-border-sm { display: none; }
            .btn .icon-idle { display: inline-block; }
            .btn.loading .spinner-border-sm { display: inline-block; }
            .btn.loading .icon-idle { display: none; }
            .btn.loading .button-text { margin-left: 0.25rem; }
            td a { color: var(--bs-link-color); text-decoration: underline; cursor: pointer; }
            td a:hover { color: var(--bs-link-hover-color); }
        </style>
    </th:block>
</head>
<body>

<!-- Ana İçerik Alanı -->
<div layout:fragment="content">
    <h2 class="mb-4 border-bottom pb-2">Kargo Sorgulama ve Güncelleme</h2>

    <!-- Filtreleme Alanı -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-funnel-fill me-2"></i>Arama Filtreleri</h5>
            <form class="row g-3 align-items-end" th:action="@{/panel/sorgula}" method="get" th:object="${searchCriteria}">
                <div class="col-lg-3 col-md-6">
                    <label for="trackingNo" class="form-label">Takip Numarası</label>
                    <input type="text" class="form-control form-control-sm" id="trackingNo" th:field="*{trackingNo}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label for="customerInfo" class="form-label">Gönderici/Alıcı Adı/Tel</label>
                    <input type="text" class="form-control form-control-sm" id="customerInfo" th:field="*{customerInfo}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label for="statusFilter" class="form-label">Durum</label>
                    <select id="statusFilter" class="form-select form-select-sm" th:field="*{statusFilter}">
                        <option value="">Tümü</option>
                        <option th:each="entry : ${statusDisplayMap}"
                                th:value="${entry.key.name()}"
                                th:text="${entry.value}">Durum Metni
                        </option>
                    </select>
                </div>
                <div class="col-lg-auto col-md-12 mt-3 mt-lg-0">
                    <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search me-1"></i> Ara</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Arama Sonuçları -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Arama Sonuçları</h4>
        <span class="text-muted" th:if="${kargoPage != null}" th:text="|Toplam ${kargoPage.totalElements} kayıt bulundu|"></span>
    </div>
    <div th:if="${kargoPage == null or kargoPage.empty}" class="alert alert-info mt-3" role="alert">
        Filtre kriterlerinize uygun kargo bulunamadı.
    </div>
    <div th:if="${kargoPage != null and not kargoPage.empty}" class="table-responsive mt-3">
        <table class="table table-striped table-hover table-bordered table-sm align-middle">
            <thead class="table-light">
            <tr>
                <th scope="col">Takip No</th>
                <th scope="col">Gönderici</th>
                <th scope="col">Alıcı</th>
                <th scope="col">Durum</th>
                <th scope="col">Son İşlem T.</th>
                <th scope="col" class="text-center">Eylemler</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="kargo : ${kargoPage.content}">
                <td>
                    <a href="javascript:void(0);" th:attr="onclick='openDetailModal(\'' + ${kargo.trackingNumber} + '\')'" th:text="${kargo.trackingNumber}"></a>
                </td>
                <td th:text="${kargo.senderName}"></td>
                <td><span th:text="${kargo.receiverName}"></span> (<span th:text="${kargo.receiverCity}"></span>)</td>
                <td><span class="badge fs-6" th:classappend="${kargo.currentStatusBadgeClass}" th:text="${kargo.currentStatus}"></span></td>
                <td th:text="${kargo.lastUpdatedAt != null ? #temporals.format(kargo.lastUpdatedAt, 'dd.MM.yy HH:mm') : '-'}"></td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-primary px-2 py-1"
                            th:attr="data-tracking-number=${kargo.trackingNumber}"
                            onclick="openDetailModal(this.getAttribute('data-tracking-number'))">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Sayfalama -->
        <th:block th:with="baseUrl='/panel/sorgula',
                            currentParams=(${#strings.isEmpty(searchCriteria.trackingNo) ? '' : '&trackingNo=' + #uris.escapePath(searchCriteria.trackingNo)}) +
                                          (${#strings.isEmpty(searchCriteria.customerInfo) ? '' : '&customerInfo=' + #uris.escapePath(searchCriteria.customerInfo)}) +
                                          (${#strings.isEmpty(searchCriteria.statusFilter) ? '' : '&statusFilter=' + searchCriteria.statusFilter})">
            <nav aria-label="Page navigation" th:if="${kargoPage.totalPages > 0}">
                <ul class="pagination justify-content-center flex-wrap">
                    <li class="page-item" th:classappend="${kargoPage.first} ? 'disabled'">
                        <a class="page-link" th:href="@{${baseUrl}(page=0, size=${kargoPage.size})} + ${currentParams}">İlk</a>
                    </li>
                    <li class="page-item" th:classappend="${kargoPage.first} ? 'disabled'">
                        <a class="page-link" th:href="@{${baseUrl}(page=${kargoPage.number - 1}, size=${kargoPage.size})} + ${currentParams}">Önceki</a>
                    </li>
                    <li class="page-item disabled"><span class="page-link" th:text="|Sayfa ${kargoPage.number + 1} / ${kargoPage.totalPages}|"></span></li>
                    <li class="page-item" th:classappend="${kargoPage.last} ? 'disabled'">
                        <a class="page-link" th:href="@{${baseUrl}(page=${kargoPage.number + 1}, size=${kargoPage.size})} + ${currentParams}">Sonraki</a>
                    </li>
                    <li class="page-item" th:classappend="${kargoPage.last} ? 'disabled'">
                        <a class="page-link" th:href="@{${baseUrl}(page=${kargoPage.totalPages - 1}, size=${kargoPage.size})} + ${currentParams}">Son</a>
                    </li>
                </ul>
            </nav>
        </th:block>
    </div>

    <!-- Detay ve Güncelleme Modalı -->
    <div class="modal fade" id="detailUpdateModal" tabindex="-1" aria-labelledby="detailUpdateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="detailUpdateModalLabel">Kargo Detayları - <span id="modalTrackingNumber" class="fw-bold"></span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalLoadingIndicator" class="text-center py-5">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Yükleniyor...</span></div>
                        <p class="mt-2 text-muted">Detaylar yükleniyor...</p>
                    </div>
                    <div id="modalErrorArea" class="alert alert-danger" style="display: none;"></div>
                    <div id="modalContentArea" style="display: none;">
                        <ul class="nav nav-tabs mb-3" id="cargoTab" role="tablist">
                            <li class="nav-item" role="presentation"> <button class="nav-link active" id="general-tab-btn" data-bs-toggle="tab" data-bs-target="#general-tab-pane" type="button" role="tab">Genel Bilgiler</button> </li>
                            <li class="nav-item" role="presentation"> <button class="nav-link" id="history-tab-btn" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab">Hareketler</button> </li>
                            <li class="nav-item" role="presentation"> <button class="nav-link" id="update-tab-btn" data-bs-toggle="tab" data-bs-target="#update-tab-pane" type="button" role="tab">İşlemler</button> </li>
                        </ul>
                        <div class="tab-content pt-2" id="cargoTabContent">
                            <div class="tab-pane fade show active" id="general-tab-pane" role="tabpanel" aria-labelledby="general-tab-btn" tabindex="0">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Gönderici Bilgileri</h5>
                                        <p id="modalSenderName" class="mb-1">-</p>
                                        <p id="modalSenderPhone" class="text-muted small mb-1">-</p>
                                        <p id="modalSenderAddress" class="text-muted small">-</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Alıcı Bilgileri</h5>
                                        <p id="modalReceiverName" class="mb-1">-</p>
                                        <p id="modalReceiverPhone" class="text-muted small mb-1">-</p>
                                        <p id="modalReceiverAddress" class="text-muted small">-</p>
                                    </div>
                                </div>
                                <hr>
                                <h5>Kargo Detayları</h5>
                                <p id="modalCargoDetails" class="mb-1">-</p>
                                <p id="modalContentDesc" class="text-muted small">-</p>
                            </div>
                            <div class="tab-pane fade" id="history-tab-pane" role="tabpanel" aria-labelledby="history-tab-btn" tabindex="0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-light"><tr><th>Tarih</th><th>Durum</th><th>Lokasyon</th></tr></thead>
                                        <tbody id="modalHistoryTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="update-tab-pane" role="tabpanel" aria-labelledby="update-tab-btn" tabindex="0">
                                <h5>İşlemler</h5>
                                <p><strong>Mevcut Durum:</strong> <span id="modalCurrentStatus" class="badge fs-6">-</span></p>
                                <hr>
                                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center align-items-center">
                                    <button id="completeStepButton" class="btn btn-success btn-lg flex-grow-1" onclick="completeStep()" disabled>
                                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                                        <i class="bi bi-check-circle-fill me-1 icon-idle"></i>
                                        <span class="button-text">Aktif Adımı Tamamla</span>
                                    </button>
                                    <button id="cancelCargoButton" class="btn btn-danger btn-lg flex-grow-1" onclick="cancelCargo()" disabled>
                                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                                        <i class="bi bi-x-octagon-fill me-1 icon-idle"></i>
                                        <span class="button-text">Kargoyu İptal Et</span>
                                    </button>
                                </div>
                                <div id="updateResultArea" class="mt-3 text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sayfaya Özel Scriptler -->
<th:block layout:fragment="pageScripts">
    <script th:inline="javascript">
        // Modal ve İçerik Elementleri
        const detailModalElement = document.getElementById('detailUpdateModal');
        const detailModal = detailModalElement ? new bootstrap.Modal(detailModalElement) : null;
        const modalLoading = document.getElementById('modalLoadingIndicator');
        const modalError = document.getElementById('modalErrorArea');
        const modalContent = document.getElementById('modalContentArea');
        const modalTrackingNumberSpan = document.getElementById('modalTrackingNumber');
        const modalSenderName = document.getElementById('modalSenderName');
        const modalSenderPhone = document.getElementById('modalSenderPhone');
        const modalSenderAddress = document.getElementById('modalSenderAddress');
        const modalReceiverName = document.getElementById('modalReceiverName');
        const modalReceiverPhone = document.getElementById('modalReceiverPhone');
        const modalReceiverAddress = document.getElementById('modalReceiverAddress');
        const modalCargoDetails = document.getElementById('modalCargoDetails');
        const modalContentDesc = document.getElementById('modalContentDesc');
        const modalHistoryTableBody = document.getElementById('modalHistoryTableBody');
        const modalCurrentStatusSpan = document.getElementById('modalCurrentStatus');
        const completeStepButton = document.getElementById('completeStepButton');
        const cancelCargoButton = document.getElementById('cancelCargoButton');
        const updateResultArea = document.getElementById('updateResultArea');

        let currentTrackingNumber = null;

        function openDetailModal(trackingNumber) {
            console.log("openDetailModal called with:", trackingNumber);
            if (!detailModal || !trackingNumber) {
                console.error("Modal veya takip no eksik!");
                return;
            }
            currentTrackingNumber = trackingNumber;
            if(modalTrackingNumberSpan) modalTrackingNumberSpan.textContent = trackingNumber;

            if(modalError) {
                modalError.style.display = 'none';
                modalError.textContent = '';
            }
            if(modalContent) modalContent.style.display = 'none';
            if(updateResultArea) updateResultArea.innerHTML = '';

            if(completeStepButton) {
                resetButtonState(completeStepButton, 'Aktif Adımı Tamamla');
                completeStepButton.disabled = true;
            }
            if(cancelCargoButton) {
                resetButtonState(cancelCargoButton, 'Kargoyu İptal Et');
                cancelCargoButton.disabled = true;
            }
            if(modalLoading) modalLoading.style.display = 'block';

            const firstTabButton = document.querySelector('#cargoTab button[data-bs-target="#general-tab-pane"]');
            if(firstTabButton) {
                const tab = bootstrap.Tab.getInstance(firstTabButton) || new bootstrap.Tab(firstTabButton);
                tab.show();
            }

            detailModal.show();

            fetch(`/api/cargos/details/${encodeURIComponent(trackingNumber)}`)
                .then(handleFetchResponse)
                .then(data => {
                    populateModal(data);
                    if(modalLoading) modalLoading.style.display = 'none';
                    if(modalContent) modalContent.style.display = 'block';
                })
                .catch(error => {
                    console.error("Modal veri çekme hatası:", error);
                    if(modalLoading) modalLoading.style.display = 'none';
                    if(modalError) {
                        modalError.textContent = `Detaylar alınamadı: ${error.message}`;
                        modalError.style.display = 'block';
                    }
                });
        }

        function populateModal(data) {
            if (!data) return;
            if(modalSenderName) modalSenderName.textContent = data.senderName || '-';
            if(modalSenderPhone) modalSenderPhone.textContent = data.senderPhone || '-';
            if(modalSenderAddress) modalSenderAddress.textContent = data.senderAddress || '-';
            if(modalReceiverName) modalReceiverName.textContent = data.receiverName || '-';
            if(modalReceiverPhone) modalReceiverPhone.textContent = data.receiverPhone || '-';
            if(modalReceiverAddress) modalReceiverAddress.textContent = data.receiverAddress || '-';

            let cargoDetailsText = '';
            if(data.weight) cargoDetailsText += `Ağırlık: ${data.weight} kg`;
            if(data.dimensions) cargoDetailsText += (cargoDetailsText ? ', Boyutlar: ' : 'Boyutlar: ') + data.dimensions;
            if(modalCargoDetails) modalCargoDetails.textContent = cargoDetailsText || '-';

            if(modalContentDesc) modalContentDesc.textContent = `İçerik: ${data.contentDescription || '-'}`;

            if(modalHistoryTableBody) {
                modalHistoryTableBody.innerHTML = '';
                if (data.historyEvents && data.historyEvents.length > 0) {
                    data.historyEvents.forEach(event => {
                        const row = modalHistoryTableBody.insertRow();
                        row.insertCell().textContent = event.timestamp ? new Date(event.timestamp).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-';
                        row.insertCell().innerHTML = `<span class="badge ${event.statusBadgeClass || 'bg-secondary'}">${event.statusDescription || '-'}</span>`;
                        row.insertCell().textContent = event.location || '-';
                    });
                } else {
                    modalHistoryTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted i">Hareket bulunamadı.</td></tr>';
                }
            }

            if(modalCurrentStatusSpan) {
                modalCurrentStatusSpan.textContent = data.currentStatus || 'Bilinmiyor';
                modalCurrentStatusSpan.className = `badge fs-6 ${data.currentStatusBadgeClass || 'bg-secondary'}`;
            }
            if(completeStepButton) completeStepButton.disabled = !(data.completable === true);
            if(cancelCargoButton) cancelCargoButton.disabled = !(data.cancellable === true);
        }

        function completeStep() {
            if (!currentTrackingNumber || !completeStepButton || !cancelCargoButton || !updateResultArea) return;
            setButtonLoading(completeStepButton, true, 'İşleniyor...');
            setButtonLoading(cancelCargoButton, true); // Diğer butonu da kilitle
            updateResultArea.innerHTML = '';

            fetch(`/api/cargos/${currentTrackingNumber}/complete-step`, { method: 'PUT' })
                .then(handleFetchResponse)
                .then(data => {
                    let message = (typeof data === 'object' && data.message) ? data.message : (typeof data === 'string' ? data : 'Adım başarıyla tamamlandı!');
                    updateResultArea.innerHTML = `<div class="alert alert-success py-2 px-3">${message}</div>`;
                    fetchDetailsAndUpdateModal(currentTrackingNumber); // Modal'ı yenile
                })
                .catch(error => {
                    console.error("Adım tamamlama hatası:", error);
                    updateResultArea.innerHTML = `<div class="alert alert-danger py-2 px-3">Hata: ${error.message}</div>`;
                    fetchDetailsAndUpdateModal(currentTrackingNumber); // Hata olsa bile modal'ı güncel durumla yenile
                });
        }

        function cancelCargo() {
            if (!currentTrackingNumber || !cancelCargoButton || !completeStepButton || !updateResultArea) return;
            if (!confirm(`'${currentTrackingNumber}' takip numaralı kargoyu iptal etmek istediğinizden emin misiniz?\nBu işlem geri alınamaz!`)) return;

            setButtonLoading(cancelCargoButton, true, 'İptal Ediliyor...');
            setButtonLoading(completeStepButton, true); // Diğer butonu da kilitle
            updateResultArea.innerHTML = '';

            fetch(`/api/cargos/${currentTrackingNumber}/cancel`, { method: 'PUT' })
                .then(handleFetchResponse)
                .then(data => {
                    let message = (typeof data === 'object' && data.message) ? data.message : (typeof data === 'string' ? data : 'Kargo iptal edildi/iptal işlemi başlatıldı.');
                    updateResultArea.innerHTML = `<div class="alert alert-warning py-2 px-3">${message}</div>`;
                    fetchDetailsAndUpdateModal(currentTrackingNumber); // Modal'ı yenile
                })
                .catch(error => {
                    console.error("Kargo iptal hatası:", error);
                    updateResultArea.innerHTML = `<div class="alert alert-danger py-2 px-3">Hata: ${error.message}</div>`;
                    fetchDetailsAndUpdateModal(currentTrackingNumber); // Hata olsa bile modal'ı güncel durumla yenile
                });
        }

        function fetchDetailsAndUpdateModal(trackingNumber) {
            fetch(`/api/cargos/details/${encodeURIComponent(trackingNumber)}`)
                .then(handleFetchResponse)
                .then(data => {
                    populateModal(data);
                    if (completeStepButton) resetButtonState(completeStepButton, 'Aktif Adımı Tamamla');
                    if (cancelCargoButton) resetButtonState(cancelCargoButton, 'Kargoyu İptal Et');
                    // Butonların disabled durumları populateModal içinde güncelleniyor.
                })
                .catch(error => {
                    console.error("Modal yenileme hatası:", error);
                    if(modalLoading) modalLoading.style.display = 'none';
                    if(modalContent) modalContent.style.display = 'none';
                    if(modalError) {
                        modalError.textContent = `Detaylar yenilenemedi: ${error.message}`;
                        modalError.style.display = 'block';
                    }
                    if(completeStepButton) completeStepButton.disabled = true;
                    if(cancelCargoButton) cancelCargoButton.disabled = true;
                });
        }

        function handleFetchResponse(response) {
            if (!response.ok) {
                return response.text().then(text => {
                    let errorMessage = `İstek başarısız: ${response.status}`;
                    if (text) {
                        try {
                            const errData = JSON.parse(text);
                            errorMessage = errData.message || errData.error || text;
                        } catch (e) { errorMessage = text; }
                    }
                    if (response.status === 404 && !errorMessage.toLowerCase().includes("bulunamadı")) {
                        errorMessage = "Belirtilen kargo bulunamadı.";
                    }
                    if (response.status === 409 && !errorMessage.toLowerCase().includes("durum")) {
                        errorMessage = "İşlem için geçersiz durum veya çakışma.";
                    }
                    throw new Error(errorMessage);
                });
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json().catch(e => {
                    console.error("JSON Parse Error:", e);
                    throw new Error("Sunucudan gelen JSON yanıt işlenemedi.");
                });
            } else {
                return response.text(); // String yanıtlar için
            }
        }

        function setButtonLoading(button, isLoading, loadingText = 'İşleniyor...') {
            if (!button) return;
            const spinner = button.querySelector('.spinner-border-sm');
            const icon = button.querySelector('.icon-idle');
            const textSpan = button.querySelector('.button-text');

            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
                if (textSpan) textSpan.textContent = loadingText;
            } else {
                button.classList.remove('loading');
                // originalText dataset'ten alınacak, resetButtonState'te set ediliyor.
                if (textSpan && button.dataset.originalText) textSpan.textContent = button.dataset.originalText;
            }
        }

        function resetButtonState(button, originalText) {
            if (!button) return;
            button.dataset.originalText = originalText; // Orijinal metni sakla
            setButtonLoading(button, false); // Yüklenme durumunu kaldır
            // setButtonLoading zaten metni güncelleyecek
        }
    </script>
</th:block>

</body>
</html>